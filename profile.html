<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Audio PWA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="nav-bar">
        <span>Settings</span>
        <a href="dashboard.html">Back to Dashboard</a>
    </div>
    <div class="container">
    <h2>Your Profile</h2>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <img id="profile-preview" src="https://via.placeholder.com/100" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
    </div>

    <input type="file" id="image-upload" accept="image/*" style="display: none;">
    <button id="upload-btn" style="background: #2c2c2c; color: white;">Choose Profile Picture</button>
    
    <input type="text" id="username-input" placeholder="Display Name">
    <button id="update-profile-btn">Save Changes</button>
    <p id="profile-msg" style="color: var(--success); text-align: center; margin-top: 10px;"></p>
</div>

<script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let currentBase64 = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = 'index.html';
        const docSnap = await getDoc(doc(db, "users", user.uid));
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('username-input').value = data.username || user.email;
            if (data.photoURL) {
                document.getElementById('profile-preview').src = data.photoURL;
                currentBase64 = data.photoURL;
            }
        }
        
        // Trigger file input
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('image-upload').click();
        });

        // Compress image using Canvas
        document.getElementById('image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to 150x150
                    const MAX_SIZE = 150;
                    canvas.width = MAX_SIZE;
                    canvas.height = MAX_SIZE;
                    
                    // Draw and crop
                    const size = Math.min(img.width, img.height);
                    const x = (img.width - size) / 2;
                    const y = (img.height - size) / 2;
                    ctx.drawImage(img, x, y, size, size, 0, 0, MAX_SIZE, MAX_SIZE);
                    
                    // Convert to Base64 with 0.7 quality
                    currentBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('profile-preview').src = currentBase64;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Save to Firestore
        document.getElementById('update-profile-btn').addEventListener('click', async () => {
            const newName = document.getElementById('username-input').value;
            const updateData = { username: newName };
            if (currentBase64) updateData.photoURL = currentBase64;
            
            await updateDoc(doc(db, "users", user.uid), updateData);
            document.getElementById('profile-msg').innerText = "Profile updated securely!";
        });
    });
</script>
</body>
</html>